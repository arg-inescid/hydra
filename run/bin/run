#!/bin/bash

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

REQUIRED_PKG="python3"
RED='\033[0;31m'
NC='\033[0m' # No Color

PKG_OK=$(dpkg-query -W --showformat='${Status}\n' $REQUIRED_PKG | grep "install ok installed")
if [ "" = "$PKG_OK" ]; then
  echo "$REQUIRED_PKG is missing! Do you want to install it?"
  sudo apt install $REQUIRED_PKG
  sudo apt install python3-pip
fi

ret=$(python3 -c 'import pkgutil; print(1 if pkgutil.find_loader("requests") else 0)')
if [ "$ret" -eq 0 ]; then
  echo -e  "${RED}python3-requests is missing! Do you want to install it? ${NC}"
  sudo apt install python3-requests
fi

ret=$(python3 -c 'import pkgutil; print(1 if pkgutil.find_loader("influxdb_client") else 0)')
if [ "$ret" -eq 0 ]; then
  echo -e  "${RED}python3-influxdb is missing! Do you want to install it? ${NC}"
  sudo apt install python3-influxdb
  pip3 install influxdb_client
fi

ret=$(python3 -c 'import pkgutil; print(1 if pkgutil.find_loader("matplotlib") else 0)')
if [ "$ret" -eq 0 ]; then
  echo -e  "${RED}python3-matplotlib is missing! Do you want to install it? ${NC}"
  sudo apt install python3-matplotlib
fi

ret=$(python3 -c 'import pkgutil; print(1 if pkgutil.find_loader("numpy") else 0)')
if [ "$ret" -eq 0 ]; then
  echo -e  "${RED}python3-numpy is missing! Do you want to install it? ${NC}"
  sudo apt install python3-numpy
fi

python3 "$DIR"/../src/run.py "$@"
